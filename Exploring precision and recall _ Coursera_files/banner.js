define("pages/open-course/s12n/views/banner",["require","exports","module","q","underscore","bundles/phoenix/lib/view","bundles/phoenix/template/models/userAuthorization","bundles/s12n-common/service/promises/s12nMembershipPromiseFactory","bundles/s12n-common/service/promises/s12nOwnershipPromiseFactory","bundles/enroll/components/EnrollModal","js/lib/coursera.redirect","pages/open-course/common/constants","bundles/product/singletons/productOwnership","pages/open-course/common/singletons/course","pages/open-course/common/singletons/courseMembership","pages/open-course/common/singletons/s12n","pages/open-course/s12n/models/banner","pages/open-course/s12n/views/banner.html","bundles/phoenix/template/models/userIdentity","pages/open-course/common/constants","js/lib/affix","css!pages/open-course/s12n/styl/banner.css"],function(require,exports,module){"use strict";var o=require("q"),_=require("underscore"),t=require("bundles/phoenix/lib/view"),c=require("bundles/phoenix/template/models/userAuthorization"),u=require("bundles/s12n-common/service/promises/s12nMembershipPromiseFactory"),s=require("bundles/s12n-common/service/promises/s12nOwnershipPromiseFactory"),i=require("bundles/enroll/components/EnrollModal"),r=require("js/lib/coursera.redirect"),a=require("pages/open-course/common/constants"),n=a.courseId,f=require("bundles/product/singletons/productOwnership"),l=require("pages/open-course/common/singletons/course"),d=require("pages/open-course/common/singletons/courseMembership"),p=require("pages/open-course/common/singletons/s12n"),h=require("pages/open-course/s12n/models/banner"),m=require("pages/open-course/s12n/views/banner.html"),b=require("bundles/phoenix/template/models/userIdentity"),g=require("pages/open-course/common/constants");require("js/lib/affix"),require("css!pages/open-course/s12n/styl/banner.css");var e=t.extend({template:m,stateModelProperty:"model",multitracker:{namespace:"specialization.course_outline_banner",baseValues:["specialization_id","open_course_id","banner_state"],definitions:{specialization_id:function specialization_id(){return this.s12n.get("id")},open_course_id:function open_course_id(){return n},banner_state:function banner_state(){return this.model.get("state")}}},render:function render(){},defaults:{state:"hidden"},events:{'click [data-js~="enroll-button"]':"openS12nModal",'click [data-js~="view-s12n-button"]':"redirectToS12n"},initialize:function initialize(t){_.bindAll(this,"setBannerState"),this.model=h,c.get("authenticated")&&e.getS12n().then(function(e){return this.s12n=e,this.course=this.s12n.get("courses").get(n),o.allSettled([s(e.get("id")),u(e.get("id")),d,f(b.get("id"),g.courseId),l]).spread(function(s,e,n,t,o){this.courseMembership=n.value,this.s12nOwnership=s.value,this.courseProductOwnership=t.value,this.course=o.value,"fulfilled"===e.state&&(this.s12nMembership=e.value)}.bind(this)).then(this.setBannerState).done()}.bind(this))},setBannerState:function setBannerState(){if(this.courseMembership.hasEnrolledRole()&&!this.s12nMembership)this.setState("takeS12n");else{var e=this.courseProductOwnership.get("expiredOwns")||this.courseProductOwnership.get("owns");e||!this.course.hasLaunched()?this.setState("hidden"):this.s12n.getHybridCourse(this.course)?this.setState("hybridCourse"):this.s12nMembership&&this.s12nMembership.isEnrolled()&&this.courseMembership.hasEnrolledRole()?this.setState("payCourse"):this.courseMembership.hasEnrolledRole()?this.setState("takeS12n"):this.setState("hidden")}},setState:function setState(e){_(["takeS12n","hybridCourse"]).contains(e)&&(this.templateOptions={s12nName:this.s12n.get("name"),s12nLink:this.s12n.getLink(),state:e}),this.model.transitionIfNot(e),this.track("render"),t.prototype.render.call(this)},openS12nModal:function openS12nModal(){this.enrollModalComponent=this.renderReactInto(i,"EnrollModal",{s12nId:this.s12n.get("id"),courseIdOverride:this.course.get("id"),showFreeOption:!this.courseMembership.hasEnrolledRole(),onClose:this.closeS12nModal.bind(this)})},closeS12nModal:function closeS12nModal(){this.removeReactComponent(this.enrollModalComponent)},redirectToS12n:function redirectToS12n(){r.setLocation(this.s12n.getLink())}},{getS12n:function getS12n(){return p.invoke("at",0)},shouldAppend:function shouldAppend(e){var n=e.course;return this.getS12n().then(function(e){return e?s(e.get("id")).then(function(e){var s=e.ownsCourse(n.get("id"));return!s}):!1})}});module.exports=e});